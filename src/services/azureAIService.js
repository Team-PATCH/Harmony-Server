const axios = require('axios');
const { ChatSession, ChatMessage } = require('../models');
require('dotenv').config();

const openAiEndpoint = process.env.OPENAI_ENDPOINT;
const apiKey = process.env.OPENAI_API_KEY;
const deploymentName = process.env.OPENAI_DEPLOYMENT_NAME;

const generateTags = async (title, image) => {
  const messages = [
    {
      role: "system",
      content: "ë‹¹ì‹ ì€ ì£¼ì–´ì§„ ì œëª©ê³¼ ì´ë¯¸ì§€ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¶”ì–µ ì¹´ë“œì˜ íƒœê·¸ë¥¼ ìƒì„±í•˜ëŠ” ë„ì›€ì„ ì£¼ëŠ” AIìž…ë‹ˆë‹¤. ë‹µë³€ìœ¼ë¡œëŠ” íƒœê·¸ë§Œ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ê°€ì¡±ê³¼ í•¨ê»˜ ì—¬í–‰ì„ ê°”ë˜ ë°”ë‹¤ ì‚¬ì§„ì´ ì œê³µë  ê²½ìš°, 'ê°€ì¡±, ì—¬í–‰, ë°”ë‹¤'ì™€ ê°™ì€ íƒœê·¸ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”. ê·¸ ì™¸ì—ë„ ì‚¬ì§„ì— ê´€í•œ ë‹¤ì–‘í•œ íƒœê·¸ë¥¼, 3~4ê°œ ì •ë„ ìƒì„±í•´ì£¼ì„¸ìš”. ë˜í•œ íƒœê·¸ì˜ ê¸€ìž ìˆ˜ë¥¼ ëª¨ë‘ í•©ì³¤ì„ ë•Œ 10ê¸€ìž ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤."
    },
    {
      role: "user",
      content: `ì œëª©: "${title}" ì´ ì´ë¯¸ì§€ì— ëŒ€í•œ íƒœê·¸ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”: ${image}`
    }
  ];

  const params = {
    messages: messages,
    max_tokens: 50,
    temperature: 0.7
  };

  try {
    const response = await axios.post(`${openAiEndpoint}/openai/deployments/${deploymentName}/chat/completions?api-version=2024-07-01-preview`, params, {
      headers: {
        "api-key": apiKey,
        "Content-Type": "application/json"
      }
    });

    if (response.data.choices && response.data.choices.length > 0) {
      const tags = response.data.choices[0].message.content.split(',').map(tag => tag.trim());
      return tags;
    } else {
      throw new Error("No tags generated by AI.");
    }
  } catch (error) {
    console.error("Error in generateTags:", error);
    throw error;
  }
};
/*
const generateInitialPrompt = async (title, image, tags) => {
  const chatSession = await ChatSession.findOne({ where: { mcId } });
    if (chatSession) {
        const messageCount = await ChatMessage.count({ where: { chatId: chatSession.chatId } });
        if (messageCount > 0) {
            return "ì´ì „ ëŒ€í™”ë¥¼ ê³„ì† ì´ì–´ê°€ë³¼ê¹Œìš”?ðŸ˜€";
        }
    }
  const messages = [
    {
      role: "system",
      content: "ë‹¹ì‹ ì€ 'ëª¨ë‹ˆ'ë¼ëŠ” ì´ë¦„ì˜ AI ì±—ë´‡ìž…ë‹ˆë‹¤. ì‚¬ìš©ìžì˜ ì¶”ì–µ ì¹´ë“œì— ëŒ€í•´ ëŒ€í™”ë¥¼ ë‚˜ëˆ„ëŠ” ê²ƒì´ ëª©ì ìž…ë‹ˆë‹¤. ì œê³µëœ ì œëª©, ì´ë¯¸ì§€(ì¦‰ ì‚¬ìš©ìžì˜ ì‚¬ì§„ìž…ë‹ˆë‹¤), íƒœê·¸ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‚¬ìš©ìžì˜ ì¶”ì–µì— ëŒ€í•´ ê³µê°í•˜ê³  ê´€ì‹¬ì„ ë³´ì´ë©°, ë” ìžì„¸í•œ ì´ì•¼ê¸°ë¥¼ ë“¤ì„ ìˆ˜ ìžˆë„ë¡ ì§ˆë¬¸ì„ í•´ì£¼ì„¸ìš”. ì¹œê·¼í•˜ê³  ë”°ëœ»í•œ í†¤ìœ¼ë¡œ ëŒ€í™”í•´ì£¼ì„¸ìš”. ë‹¹ì‹ ì˜ ë‹µë³€ì€ ë‘ ì¤„ ë¯¸ë§Œìœ¼ë¡œ ê°„ê²°í•´ì•¼ í•˜ê³ , ì´ë¯¸ì§€(ì‚¬ì§„)ì™€ ì´ ì¶”ì–µ ì¹´ë“œì— ëŒ€í•´ ì¸ì‹í•˜ê³  ìžˆë‹¤ëŠ” ê²ƒì„ ì‚¬ìš©ìžê°€ ëŠë‚„ ìˆ˜ ìžˆê²Œ í•˜ë©° ë”°ëœ»í•¨ê³¼ ê³µê° ëŠ¥ë ¥ì„ ìœ ì§€í•´ì£¼ì„¸ìš”."
    },
    {
      role: "user",
      content: `ì¶”ì–µ ì¹´ë“œ ì •ë³´ - ì œëª©: "${title}", íƒœê·¸: ${tags.join(', ')}, ì´ë¯¸ì§€: ${image}`
    }
  ];

  const params = {
    messages: messages,
    max_tokens: 200,
    temperature: 0.7
  };

  try {
    const response = await axios.post(`${openAiEndpoint}/openai/deployments/${deploymentName}/chat/completions?api-version=2024-07-01-preview`, params, {
      headers: {
        "api-key": apiKey,
        "Content-Type": "application/json"
      }
    });

    if (response.data.choices && response.data.choices.length > 0) {
      return response.data.choices[0].message.content;
    } else {
      throw new Error("No initial prompt generated by AI.");
    }
  } catch (error) {
    console.error("Error in generateInitialPrompt:", error);
    throw error;
  }
};
*/

const generateInitialPrompt = async (mcId, title, image, tags) => {
  try {
      const chatSession = await ChatSession.findOne({ where: { mcId } });
      if (chatSession) {
          const messageCount = await ChatMessage.count({ where: { chatId: chatSession.chatId } });
          if (messageCount > 0) {
              return "ì´ì „ ëŒ€í™”ë¥¼ ì´ì–´ê°ˆê¹Œìš”?";
          }
      }

      const tagString = Array.isArray(tags) ? tags.join(', ') : '';

      const messages = [
          {
              role: "system",
              content: "ë‹¹ì‹ ì€ 'ëª¨ë‹ˆ'ë¼ëŠ” ì´ë¦„ì˜ AI ì±—ë´‡ìž…ë‹ˆë‹¤. ì‚¬ìš©ìžì˜ ì¶”ì–µ ì¹´ë“œì— ëŒ€í•´ ëŒ€í™”ë¥¼ ë‚˜ëˆ„ëŠ” ê²ƒì´ ëª©ì ìž…ë‹ˆë‹¤. ì œê³µëœ ì œëª©, ì´ë¯¸ì§€(ì¦‰ ì‚¬ìš©ìžì˜ ì‚¬ì§„ìž…ë‹ˆë‹¤), íƒœê·¸ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‚¬ìš©ìžì˜ ì¶”ì–µì— ëŒ€í•´ ê³µê°í•˜ê³  ê´€ì‹¬ì„ ë³´ì´ë©°, ë” ìžì„¸í•œ ì´ì•¼ê¸°ë¥¼ ë“¤ì„ ìˆ˜ ìžˆë„ë¡ ì§ˆë¬¸ì„ í•´ì£¼ì„¸ìš”. ì¹œê·¼í•˜ê³  ë”°ëœ»í•œ í†¤ìœ¼ë¡œ ëŒ€í™”í•´ì£¼ì„¸ìš”. ë‹¹ì‹ ì˜ ë‹µë³€ì€ ë‘ ì¤„ ë¯¸ë§Œìœ¼ë¡œ ê°„ê²°í•´ì•¼ í•˜ê³ , ì´ë¯¸ì§€(ì‚¬ì§„)ì™€ ì´ ì¶”ì–µ ì¹´ë“œì— ëŒ€í•´ ì¸ì‹í•˜ê³  ìžˆë‹¤ëŠ” ê²ƒì„ ì‚¬ìš©ìžê°€ ëŠë‚„ ìˆ˜ ìžˆê²Œ í•˜ë©° ë”°ëœ»í•¨ê³¼ ê³µê° ëŠ¥ë ¥ì„ ìœ ì§€í•´ì£¼ì„¸ìš”."
          },
          {
              role: "user",
              content: `ì œëª©: "${title}", íƒœê·¸: ${tagString}, ì´ë¯¸ì§€: ${image}`
          }
      ];

      const params = {
          messages: messages,
          max_tokens: 150,
          temperature: 0.7
      };

      const response = await axios.post(`${openAiEndpoint}/openai/deployments/${deploymentName}/chat/completions?api-version=2024-07-01-preview`, params, {
          headers: {
              "api-key": apiKey,
              "Content-Type": "application/json"
          }
      });

      if (response.data.choices && response.data.choices.length > 0) {
          return response.data.choices[0].message.content;
      } else {
          throw new Error("No initial prompt generated by AI.");
      }
  } catch (error) {
      console.error("Error in generateInitialPrompt:", error);
      throw error;
  }
};


const generateSummary = async (conversation) => {
  const messages = [
    {
      role: "system",
      content: "ë‹¹ì‹ ì€ 'ì¶”ì–µ ì¹´ë“œ'ë¼ê³  í•˜ëŠ” ê¸°ëŠ¥ì—ì„œ ë…¸ì¸ê³¼ ê°€ì¡±ì˜ ì¶”ì–µ ê¸°ë¡ì˜ ëŒ€í™”ë¥¼ ìš”ì•½í•˜ëŠ” AI ì–´ì‹œìŠ¤í„´íŠ¸ìž…ë‹ˆë‹¤. ì£¼ì–´ì§„ ëŒ€í™” ë‚´ìš©ì„ ë…¸ì¸ì—ê²Œ ì¹œí™”ì ì¸ ë¬¸êµ¬ì™€ ë”°ëœ»í•œ ë§íˆ¬ë¡œ 4~5ì¤„ ì •ë„ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”. ëŒ€í™” ë‚´ìš©ì€ ì±—ë´‡ê³¼ì˜ ëŒ€í™” ë‚´ìš©ì´ê¸°ì—, ê·¸ê±¸ ê·¸ëŒ€ë¡œ ê°€ì ¸ì˜¤ê±°ë‚˜, ì´ë¦„ì„ ë¶€ë¥´ê±°ë‚˜ ì§ˆë¬¸í•˜ëŠ” ë“± ìš”ì•½ê°™ì§€ ì•Šì€ ë‚´ìš©ì€ ìžì œí•´ì£¼ì„¸ìš”."
    },
    {
      role: "user",
      content: `ë‹¤ìŒ ëŒ€í™”ë¥¼ ìš”ì•½í•´ì£¼ì„¸ìš”: ${conversation}`
    }
  ];

  const params = {
    messages: messages,
    max_tokens: 200,
    temperature: 0.7
  };

  try {
    const response = await axios.post(`${openAiEndpoint}/openai/deployments/${deploymentName}/chat/completions?api-version=2024-07-01-preview`, params, {
      headers: {
        "api-key": apiKey,
        "Content-Type": "application/json"
      }
    });

    if (response.data.choices && response.data.choices.length > 0) {
      return response.data.choices[0].message.content;
    } else {
      throw new Error("No summary generated by AI.");
    }
  } catch (error) {
    console.error("Error in generateSummary:", error);
    throw error;
  }
};

module.exports = {
  generateTags,
  generateInitialPrompt,
  generateSummary
};

